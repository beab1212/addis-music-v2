import config from "./config/config";
import express, { Router } from "express";
import cors from "cors";
import { toNodeHandler } from "better-auth/node";
import prisma from "./libs/db";
import meiliClient, { checkMeiliConnection } from "./libs/meili";
import { auth } from "./libs/auth";
import { errorHandler } from "./middlewares/errorHandler";
import authRoute from "./routes/authRoutes";
import systemRoute from "./routes/systemRoutes";
import userRoute from "./routes/userRoutes";
import genreRoute from "./routes/genreRoutes";
import artistRoute from "./routes/artistRoutes";
import albumRoute from "./routes/albumRoutes";
import playlistRoute from "./routes/playlistRoutes";
import playlistTrackRoute from "./routes/playlistItemRoutes";
import tagRoute from "./routes/tagRoutes";
import trackLikeRoute from "./routes/trackLikeRoutes";
import playHistoryRoute from "./routes/playHistoryRoutes";
import artistFollowRoute from "./routes/artistFollowRoutes";
import userFollowRoute from "./routes/userFollowRouter";
import trackRoute from "./routes/trackRoutes";
import streamRoute from "./routes/streamRoutes";
import personalizationRoute from "./routes/personalizationRoutes";
import advertisementRoute from "./routes/advertisementRouter";
import { subscriptionController } from "./controllers/subscriptionController";
import subscriptionRoute from "./routes/subscriptionRoutes";


const app = express();


app.use(cors(config.corsOptions));

app.all("/api/auth/{*any}", toNodeHandler(auth));
app.use("/api/auth", authRoute);

app.use(express.json());
app.use(express.urlencoded({ extended: true }));


app.use("/stream", streamRoute);

const api = Router();
app.use("/api", api);


api.use("/system",systemRoute);
api.use("/user", userRoute);
api.use("/genres", genreRoute);
api.use("/artists", artistRoute);
api.use("/albums", albumRoute);
api.use("/playlists", playlistRoute);
api.use("/playlist-items", playlistTrackRoute);
api.use("/tags", tagRoute);
// main track route here
api.use("/track-likes", trackLikeRoute);
api.use("/play-history", playHistoryRoute);
api.use("/artist-follows", artistFollowRoute);
api.use("/user-follows", userFollowRoute);
api.use("/tracks", trackRoute);
api.use("/personalization", personalizationRoute);
api.use("/ads", advertisementRoute);
api.use("/subscriptions", subscriptionRoute);
app.get("/api/v1/payments/chapa/callback/:paymentId", subscriptionController.chapaCallback);


import { embeddingQueue, embeddingQueueEvents, personalizationQueue, personalizationQueueEvents } from './jobs/audioQueue';
import { getSimilarTracks } from "./prisma/vectorQueries";
import { acceptPayment } from "./utils/payment_helpers";


app.get("/test", async (_req, res) => {
    const searchQuery = "Abbey Road";
    const job = await embeddingQueue.add('embedding', { type: 'search_query', query_text: searchQuery });

    try {
        const result = await job.waitUntilFinished(embeddingQueueEvents);
        console.log("Job completed with result:", result);

        const embedding = `[${result.data.join(",")}]`;

        // select album based on embedding
        const queryResult = await prisma.$queryRaw<
            any[]
            >`
            SELECT 
                "id", "title", "artistId", "genreId", "coverUrl", "releaseDate", "createdAt"

            FROM "Album"
            ORDER BY "embeddingVector" <=> ${embedding}::vector
            LIMIT 10;
            `;
        console.log("Query Result: ", queryResult);
            

        res.json({ jobId: job.id });
    } catch (err: any) {
        console.error("Job failed with error:", err);
        res.status(500).json({ jobId: job.id, error: err?.message ?? String(err) });
    }




    // const userMetaVector = [-0.05971934,0.025424127,-0.008057252,-0.015435528,-0.06709256,0.08283644,0.04372886,-0.03561466,0.008558506,-0.014007014,-0.04882177,-0.121727735,-0.042909995,-0.07706471,-0.04480917,0.010085308,0.023161167,0.007257035,0.034244686,-0.06725191,-0.048764702,0.004952493,0.068324335,-0.0078017507,0.0042364597,-0.014036134,0.015566817,-0.010370485,0.015642831,-0.09493879,0.066316485,0.07125417,-0.045440145,-0.0009891894,-0.017474024,0.009431827,-0.012633145,0.078078575,0.034523252,-0.061251957,0.093986146,-0.05525441,-0.021637887,-0.05302558,-0.011686166,-0.024695318,-0.0557835,0.012012635,-0.028044047,0.023764063,-0.06516084,0.025563164,0.017103918,0.04288223,0.015340676,-0.0051884605,0.0504214,0.038086005,0.07198809,0.03350542,-0.023699347,-0.03991045,-0.028980063,-0.023095846,0.04667607,-0.08410618,0.023575362,0.06720512,0.01658193,0.011745799,0.06196199,-0.017721437,-0.017492006,-0.028352356,0.00810161,0.03992903,0.028022802,0.0042202487,0.074850895,-0.07984353,0.0058619836,-0.038540993,0.055897236,-0.09967696,-0.020665912,0.0069962656,0.038585767,0.07619455,-0.072562315,-0.093818255,0.044047743,0.048093773,-0.019899081,-0.016421692,0.042537194,-0.04038686,0.03380776,-0.011891175,0.020048419,0.08304353,0.009227046,-0.020670302,-0.019337373,-0.01338451,-0.034009516,-0.086626396,0.11013792,0.0038716835,0.056019392,0.019655762,0.001552513,0.0018405495,-0.07031146,0.032609154,0.09045073,-0.007070742,-0.037252493,0.056191042,0.038487792,-0.037513725,0.002735937,-0.015221646,-0.005662378,-0.03724987,0.008356386,0.026668709,-0.011827285,2.6152332e-33,0.07832959,-0.089762755,-0.0069950568,0.030740649,0.05607195,0.003348112,-0.033967208,0.09881706,-0.021632833,0.06293034,-0.018293502,-0.06157739,-0.09946213,0.05232185,-0.030445904,0.008787269,-0.00017595221,-0.02446653,-0.009340413,-0.034928862,-0.01598632,-0.011005446,0.026469061,-0.019527905,0.08821241,-0.035816807,-0.009900175,-0.055410527,0.034092426,0.044907123,-0.010504208,-0.000908843,-0.03520298,-0.04920452,-0.06753946,0.022895154,-0.1134524,-0.0124212485,-0.023364395,0.0076910085,0.040375233,-0.023204198,-0.007477611,-0.13261916,-0.06183953,0.019825827,0.040150505,-0.0498593,0.053187624,0.0076732044,0.011564493,-0.023955042,-0.016459256,-0.03636997,0.052957557,-0.03397375,-0.056220915,-0.0416063,0.108087175,0.06080483,0.028488759,0.010558994,-0.006829808,-0.059298493,0.067901775,0.012433863,0.043702114,0.033800397,0.05387676,-0.08460591,0.017174773,-0.062204164,-0.041982476,-0.056366302,-0.017198358,-0.013144716,0.052191943,0.026312629,0.06229562,0.08534836,0.06218139,0.010105633,-0.0192146,-0.0047540884,-0.03450026,0.03471901,0.03751429,-0.021378426,-0.016972113,0.012207568,-0.050321486,0.08088301,-0.05345145,0.019385252,-0.009369969,-4.351624e-33,0.05321487,0.06284687,-0.013418113,0.01760946,0.12681717,-0.05731883,0.078208596,0.12560882,0.061254404,-0.022198055,0.038229708,-0.02674811,0.07871479,-0.0009064978,0.00017378511,-0.018714437,-0.01837731,-0.0076970537,0.0208123,0.05506125,-0.029687017,0.031135794,0.009447297,-0.041898992,0.011273775,-0.053797398,0.09672181,0.045636833,-0.014730425,0.002779635,0.0019276694,0.01983137,-0.09938015,-0.018875616,-0.018373683,-0.09148759,0.0422448,-0.029811827,-0.003719541,0.06564156,-0.010793931,0.0694448,-0.061897818,0.026669487,0.029133765,-0.033138253,-0.006363938,0.10006278,0.037768267,0.0076996745,-0.01882016,-0.03772194,-0.018196177,-0.013753633,0.03129289,-0.05913649,-0.054193627,-0.05356447,-0.009828733,0.025780495,-0.067361966,0.020512389,-0.0014892338,-0.11755866,0.0080379015,0.11487517,0.013171136,-0.020602114,-0.005078032,-0.035319712,0.10105071,-0.07994492,-0.10866457,0.012688412,-0.14536355,0.033948656,-0.05480428,0.016894206,0.05519513,-0.13427809,-0.010780691,-0.025341194,-0.093330845,0.043249242,0.013866443,0.08517078,0.012723569,-0.039145257,0.0636315,0.029647764,0.039150815,-0.010462398,-0.07060258,0.06866964,-0.025669314,-3.3814054e-08,-0.0076291705,0.004906816,0.03726866,0.02580839,0.11193258,0.1181559,0.0012781284,-0.12075609,0.08089903,0.058266997,0.017137613,0.007800943,0.039573185,0.0014222931,-0.011845155,-0.0028635778,-0.08671207,-4.1076033e-05,-0.021071177,-0.030771177,0.032305457,0.028102202,0.11228853,-0.09829012,-0.07167897,-0.009987383,-0.041310947,-0.047306165,-0.064440444,-0.06768261,0.060030606,0.12163415,0.047166657,-0.058253404,0.025144769,-0.03556815,0.029521752,0.01727546,-0.01726652,-0.047185097,0.0015566144,0.029345926,0.09577577,-0.041469898,-0.0693009,-0.07868783,-0.020413572,-0.0010663307,-0.06467947,0.0077057737,-0.04020514,-0.016908249,0.0781586,0.023701996,0.093215786,-0.026730398,-0.08033901,0.009581974,-0.0134685915,0.014020938,0.10276293,-0.11387213,-0.020509513,-0.070237376];
    // const userAudioVector = [-0.05386307,0.008255064,0.04514004,0.02856933,0.015158569,-0.030354947,0.021328274,0.004553039,0.022240097,-0.041585784,0.024531119,-0.05406301,-0.0446994,0.034547564,-0.033467837,0.028835014,0.025396572,-0.115595266,0.038964197,0.021354947,0.050962895,0.021069365,-0.044349067,0.017282294,-0.034523636,0.027447127,-0.0048358035,0.008460597,-0.014009288,-0.051556237,-0.06660077,0.037184708,0.033883315,-0.0046714763,-0.010694974,-0.027390683,-0.04306461,0.0020334234,-0.1121812,-0.056592442,-0.030162608,-0.012924173,-0.014784213,0.016185733,-0.043887477,0.020461319,0.09282628,-0.0005985677,0.011473723,-0.057001628,-0.011932115,0.0035451457,-0.03187977,-0.007451531,0.060615055,0.010950391,-0.016812604,-0.02696822,-0.08419769,0.11365659,-0.10623544,-0.028556598,0.047633674,0.016472429,-0.005366851,0.034429595,-0.112886816,0.06837568,-0.03846324,-0.001212928,0.089310855,0.013615264,0.049389016,-0.05057697,-0.046066027,-0.036467627,0.018306436,0.016880134,-0.061091095,0.035925098,0.021182895,-0.010602254,0.02340669,-0.0181827,-0.01549893,0.07052632,-0.049111642,0.03363411,0.015194507,-0.04556587,-0.027583193,-0.023525955,-0.043849185,0.05034977,-0.024715422,-0.004355057,-0.023777619,0.026944457,0.036826484,-0.034505077,-0.067862466,0.051117677,0.019219413,-0.021471595,0.06429669,-0.025666479,0.05689009,-0.011757207,0.046791844,-0.043154906,-0.004414149,0.040884446,0.020423075,-0.1129407,0.0057469113,0.07654411,0.012174194,0.05089464,-0.01749614,0.038422395,0.0046854196,0.05452699,-0.10576373,-0.0046467003,-0.033429034,0.010824435,0.004266026,0.0082920585,-0.02599979,0.08837874,-0.023683414,-0.094822176,-0.1264345,0.05600633,-0.021641416,-0.008119315,0.05325958,-0.02370975,0.10952094,0.017129345,-0.034638084,-0.026820654,0.05722812,-0.002324728,0.05028908,-0.008218442,0.050275538,0.019353162,-0.05860458,-0.0014378938,0.052555192,0.00957124,0.0007021637,0.051980697,-0.003196968,0.063144766,-0.054417983,0.0040279385,-0.015293808,-0.009473254,-0.009689301,0.0058664563,0.0074544195,0.07207297,0.07886034,0.021522345,-0.045910034,0.006121455,-0.024789829,0.036537837,0.030594038,-0.017870158,-0.001321499,0.032908607,-0.047813077,0.052081957,-0.051104132,0.029609881,-0.026511533,0.039299592,-0.044686954,0.051908717,0.0091067115,0.022242425,-0.023674713,-0.05070439,0.037780713,0.0065790806,0.0646386,0.011229517,-0.06137665,-0.011393538,-0.024234926,-0.04988514,0.046570864,0.049737304,0.0266327,0.018367011,0.03306038,-0.019840984,-0.023039414,-0.014032451,0.04032835,-0.033200666,-0.019718995,-0.031827763,0.013427951,0.08930789,0.050143775,-0.05077802,-0.03427353,0.034902193,-0.032161564,0.013676163,0.0048825764,0.026097499,-0.024965094,0.13371634,0.068391785,0.02509944,0.004497489,-0.011126906,-0.033925027,-0.044707395,0.022925222,-0.04350484,0.08797356,0.05059506,-0.012325931,-0.0025478837,-0.022486072,-0.016746292,-0.039061937,-0.045934692,0.033822205,0.014692465,0.001473715,0.07835861,0.00802561,0.027276898,0.023955686,-0.015924241,-0.0069416887,-0.030370012,0.018426808,-0.054805584,0.061045926,0.07911404,0.09015568,-0.042597238,-0.0021180091,0.09615075,-0.006128013,-0.050266583,-0.11343361,-0.08838576,-0.0067529953,-0.10739916,-0.023531552,-0.06662341,0.030273518,0.0013645557,-0.011052472,5.6677196e-05,0.07633633,-0.045672677,0.0033867112,-0.052861184,-0.075294495,0.021035008,0.029253185,-0.0013376068,-0.022464467,0.07884721,0.013656691,-0.014404084,0.03558089,-0.07095162,0.06658084,0.03711173,-0.058687516,-0.07921782,-0.008312971,0.03273574,-0.01919945,0.095105484,-0.06091208,-0.0027423725,-0.030208712,-0.021635113,0.048506282,-0.08291194,0.06380567,0.009567457,0.02028176,0.011818844,-0.051582046,0.07189281,0.006746239,-0.06274333,0.03248986,0.019940965,-0.025272323,0.022019237,-0.06445909,-0.007469954,-0.038223423,-0.021058423,0.058993977,-0.07617005,-0.051416945,0.09213951,-0.0050497884,-0.012077998,-0.03855338,-0.0067251604,0.009614544,0.04969416,-0.009720075,-0.00041260882,-0.02515093,-0.038492385,0.03980387,-0.029302016,-0.038348783,0.06979295,-0.019338515,0.059507076,0.010192569,0.058152527,0.065654054,0.044415846,-0.065235466,0.019773085,0.00971597,0.05274229,0.004432235,0.050715838,-0.012443503,0.021463495,0.02648536,0.060078986,0.0115550775,-0.03547104,-0.027971404,-0.014049811,-0.061259307,-0.01851393,0.04286346,-0.0076317354,0.0044700224,0.012647326,0.027243363,-0.044434123,-0.0123073,0.011856936,-0.073055714,0.0018443014,0.05227167,-0.04410793,-0.029918274,0.024853954,0.03836903,-0.034092143,-0.058706887,-0.0756049,0.014278019,0.031617012,-0.017461168,0.009829327,-0.10069472,0.051267944,-0.0068916394,0.03710378,0.048037052,0.024384469,0.034401324,-0.056317303,0.08557087,0.0074534095,0.011688734,0.024365814,0.027451582,-0.031024773,0.062032133,-0.034447912,0.024265638,0.0283395,0.0042871544,-0.004562375,-0.003487252,-0.031356346,-0.054202545,0.08368391,0.052564602,0.019964881,-0.0015574442,0.049014695,-0.09467218,0.052238744,0.03659237,-0.016266119,-0.03209049,-0.09333953,-0.08312606,0.019925296,-0.08004056,-0.044507433,0.008357446,-0.0030326308,0.09274803,0.04254557,0.062131982,0.007715447,-0.04619158,-0.09991907,0.08369983,-0.0073103914,0.037906256,0.00826545,0.09267563,0.012445924,-0.007291163,0.033581782,-0.030854132,0.039220724,-0.031942796,-0.0040918095,0.054336566,-0.042179286,-0.021568665,-0.01124957,-0.012953584,-0.034294054,-0.038118526,0.013390706,-0.067669146,0.051618975,0.0017489073,0.0076044016,-0.03212289,0.016433647,0.03721319,0.08770608,-0.030165276,0.0026114772,-0.021648489,-0.00052351377,-0.0060494808,0.01286576,0.019027764,-0.02894776,0.01009484,-0.0072811767,-0.010323611,0.019536654,-0.035621975,-0.015462298,-0.028478526,0.06514238,0.0025031362,0.014679623,0.01338461,0.0022573106,0.009540572,0.005970255,-0.04629968,-0.018328667,-0.014824297,-0.010894553,-0.09420818,0.025692724,-0.027567375,-0.08087839,0.010994398,0.053091053,0.022758765,0.0148088215,0.010953385,0.00917772,-0.03339023,-0.020005148,-0.018871218,0.006160135,0.09745973,-0.010673146,0.008810982,0.029076604,0.02887497,0.054840416,0.06157483,-0.04833444,0.030095907,0.065480135,-0.04805046,0.004796316,-0.00987801,0.037457068,0.07092381,0.020898554,0.044935197,0.0150994435,0.11534044,-0.028164903,0.008736716,-0.0075018583,-0.012983797,-0.02020114,0.06625565,-0.00356062,0.03040632,-0.02258936]

    // const results = await getSimilarTracks(userMetaVector, userAudioVector, 10);
    // res.json({ results});


    // const userId = "pnoh3p2yCJMa9AjH18bnCiDhCmtGeM8s";

    // const job = await personalizationQueue.add('personalization', { type: 'for_you', user_id: userId });

    // try {
    //     const result = await job.waitUntilFinished(personalizationQueueEvents);
    //     console.log("Job completed with result:", result);
    //     res.json({ jobId: job.id, result });
    // } catch (err: any) {
    //     console.error("Job failed with error:", err);
    //     res.status(500).json({ jobId: job.id, error: err?.message ?? String(err) });
    // }
});


app.use(errorHandler);


app.listen(config.port, () => {
    console.log(`Backend listening on port ${config.port}`);
    checkMeiliConnection();
});
