import config from "./config/config";
import express, { Router } from "express";
import cors from "cors";
import { toNodeHandler } from "better-auth/node";
import prisma from "./libs/db";
// import meiliClient, { checkMeiliConnection } from "./libs/meili";
import { auth } from "./libs/auth";
import { errorHandler } from "./middlewares/errorHandler";
import authRoute from "./routes/authRoutes";
import systemRoute from "./routes/systemRoutes";
import userRoute from "./routes/userRoutes";
import genreRoute from "./routes/genreRoutes";
import artistRoute from "./routes/artistRoutes";
import albumRoute from "./routes/albumRoutes";
import playlistRoute from "./routes/playlistRoutes";
import playlistTrackRoute from "./routes/playlistItemRoutes";
import tagRoute from "./routes/tagRoutes";
import trackLikeRoute from "./routes/trackLikeRoutes";
import playHistoryRoute from "./routes/playHistoryRoutes";
import artistFollowRoute from "./routes/artistFollowRoutes";
import userFollowRoute from "./routes/userFollowRouter";
import trackRoute from "./routes/trackRoutes";
import streamRoute from "./routes/streamRoutes";
import personalizationRoute from "./routes/personalizationRoutes";
import advertisementRoute from "./routes/advertisementRouter";
import { subscriptionController } from "./controllers/subscriptionController";
import subscriptionRoute from "./routes/subscriptionRoutes";
import genreTrackRoute from "./routes/genreTracksRouter";
import adminUserRoute from "./routes/adminUserRouter";
import  adminAnalyticsRouter  from "./routes/adminAnalyticsRouter";


const app = express();


app.use(cors(config.corsOptions));

app.all("/api/auth/{*any}", toNodeHandler(auth));
app.use("/api/auth", authRoute);

app.use(express.json());
app.use(express.urlencoded({ extended: true }));


app.use("/stream", streamRoute);

const api = Router();
app.use("/api", api);

app.use("/api/admin", adminUserRoute);
api.use("/admin/analytics", adminAnalyticsRouter);


api.use("/system", systemRoute);
api.use("/user", userRoute);
api.use("/genres", genreRoute);
api.use("/artists", artistRoute);
api.use("/albums", albumRoute);
api.use("/playlists", playlistRoute);
api.use("/playlist-items", playlistTrackRoute);
api.use("/tags", tagRoute);
// main track route here
api.use("/track-likes", trackLikeRoute);
api.use("/play-history", playHistoryRoute);
api.use("/artist-follows", artistFollowRoute);
api.use("/user-follows", userFollowRoute);
api.use("/tracks", trackRoute);
api.use("/personalization", personalizationRoute);
api.use("/genre-tracks", genreTrackRoute);
api.use("/ads", advertisementRoute);
api.use("/subscriptions", subscriptionRoute);
app.get("/api/v1/payments/chapa/callback/:paymentId", subscriptionController.chapaCallback);


import { embeddingQueue, embeddingQueueEvents, personalizationQueue, personalizationQueueEvents } from './jobs/audioQueue';
import { getSimilarTracks, getSimilarSoundingTracks } from "./prisma/vectorQueries";
import { acceptPayment } from "./utils/payment_helpers";


app.get("/test", async (_req, res) => {
    // const searchQuery = "Abbey Road";
    // const job = await embeddingQueue.add('embedding', { type: 'search_query', query_text: searchQuery });

    // try {
    //     const result = await job.waitUntilFinished(embeddingQueueEvents);
    //     console.log("Job completed with result:", result);

    //     const embedding = `[${result.data.join(",")}]`;

    //     // select album based on embedding
    //     const queryResult = await prisma.$queryRaw<
    //         any[]
    //         >`
    //         SELECT 
    //             "id", "title", "artistId", "genreId", "coverUrl", "releaseDate", "createdAt"

    //         FROM "Album"
    //         ORDER BY "embeddingVector" <=> ${embedding}::vector
    //         LIMIT 10;
    //         `;
    //     console.log("Query Result: ", queryResult);


    //     res.json({ jobId: job.id });
    // } catch (err: any) {
    //     console.error("Job failed with error:", err);
    //     res.status(500).json({ jobId: job.id, error: err?.message ?? String(err) });
    // }




    const userMetaVector = [-0.05971934, 0.025424127, -0.008057252, -0.015435528, -0.06709256, 0.08283644, 0.04372886, -0.03561466, 0.008558506, -0.014007014, -0.04882177, -0.121727735, -0.042909995, -0.07706471, -0.04480917, 0.010085308, 0.023161167, 0.007257035, 0.034244686, -0.06725191, -0.048764702, 0.004952493, 0.068324335, -0.0078017507, 0.0042364597, -0.014036134, 0.015566817, -0.010370485, 0.015642831, -0.09493879, 0.066316485, 0.07125417, -0.045440145, -0.0009891894, -0.017474024, 0.009431827, -0.012633145, 0.078078575, 0.034523252, -0.061251957, 0.093986146, -0.05525441, -0.021637887, -0.05302558, -0.011686166, -0.024695318, -0.0557835, 0.012012635, -0.028044047, 0.023764063, -0.06516084, 0.025563164, 0.017103918, 0.04288223, 0.015340676, -0.0051884605, 0.0504214, 0.038086005, 0.07198809, 0.03350542, -0.023699347, -0.03991045, -0.028980063, -0.023095846, 0.04667607, -0.08410618, 0.023575362, 0.06720512, 0.01658193, 0.011745799, 0.06196199, -0.017721437, -0.017492006, -0.028352356, 0.00810161, 0.03992903, 0.028022802, 0.0042202487, 0.074850895, -0.07984353, 0.0058619836, -0.038540993, 0.055897236, -0.09967696, -0.020665912, 0.0069962656, 0.038585767, 0.07619455, -0.072562315, -0.093818255, 0.044047743, 0.048093773, -0.019899081, -0.016421692, 0.042537194, -0.04038686, 0.03380776, -0.011891175, 0.020048419, 0.08304353, 0.009227046, -0.020670302, -0.019337373, -0.01338451, -0.034009516, -0.086626396, 0.11013792, 0.0038716835, 0.056019392, 0.019655762, 0.001552513, 0.0018405495, -0.07031146, 0.032609154, 0.09045073, -0.007070742, -0.037252493, 0.056191042, 0.038487792, -0.037513725, 0.002735937, -0.015221646, -0.005662378, -0.03724987, 0.008356386, 0.026668709, -0.011827285, 2.6152332e-33, 0.07832959, -0.089762755, -0.0069950568, 0.030740649, 0.05607195, 0.003348112, -0.033967208, 0.09881706, -0.021632833, 0.06293034, -0.018293502, -0.06157739, -0.09946213, 0.05232185, -0.030445904, 0.008787269, -0.00017595221, -0.02446653, -0.009340413, -0.034928862, -0.01598632, -0.011005446, 0.026469061, -0.019527905, 0.08821241, -0.035816807, -0.009900175, -0.055410527, 0.034092426, 0.044907123, -0.010504208, -0.000908843, -0.03520298, -0.04920452, -0.06753946, 0.022895154, -0.1134524, -0.0124212485, -0.023364395, 0.0076910085, 0.040375233, -0.023204198, -0.007477611, -0.13261916, -0.06183953, 0.019825827, 0.040150505, -0.0498593, 0.053187624, 0.0076732044, 0.011564493, -0.023955042, -0.016459256, -0.03636997, 0.052957557, -0.03397375, -0.056220915, -0.0416063, 0.108087175, 0.06080483, 0.028488759, 0.010558994, -0.006829808, -0.059298493, 0.067901775, 0.012433863, 0.043702114, 0.033800397, 0.05387676, -0.08460591, 0.017174773, -0.062204164, -0.041982476, -0.056366302, -0.017198358, -0.013144716, 0.052191943, 0.026312629, 0.06229562, 0.08534836, 0.06218139, 0.010105633, -0.0192146, -0.0047540884, -0.03450026, 0.03471901, 0.03751429, -0.021378426, -0.016972113, 0.012207568, -0.050321486, 0.08088301, -0.05345145, 0.019385252, -0.009369969, -4.351624e-33, 0.05321487, 0.06284687, -0.013418113, 0.01760946, 0.12681717, -0.05731883, 0.078208596, 0.12560882, 0.061254404, -0.022198055, 0.038229708, -0.02674811, 0.07871479, -0.0009064978, 0.00017378511, -0.018714437, -0.01837731, -0.0076970537, 0.0208123, 0.05506125, -0.029687017, 0.031135794, 0.009447297, -0.041898992, 0.011273775, -0.053797398, 0.09672181, 0.045636833, -0.014730425, 0.002779635, 0.0019276694, 0.01983137, -0.09938015, -0.018875616, -0.018373683, -0.09148759, 0.0422448, -0.029811827, -0.003719541, 0.06564156, -0.010793931, 0.0694448, -0.061897818, 0.026669487, 0.029133765, -0.033138253, -0.006363938, 0.10006278, 0.037768267, 0.0076996745, -0.01882016, -0.03772194, -0.018196177, -0.013753633, 0.03129289, -0.05913649, -0.054193627, -0.05356447, -0.009828733, 0.025780495, -0.067361966, 0.020512389, -0.0014892338, -0.11755866, 0.0080379015, 0.11487517, 0.013171136, -0.020602114, -0.005078032, -0.035319712, 0.10105071, -0.07994492, -0.10866457, 0.012688412, -0.14536355, 0.033948656, -0.05480428, 0.016894206, 0.05519513, -0.13427809, -0.010780691, -0.025341194, -0.093330845, 0.043249242, 0.013866443, 0.08517078, 0.012723569, -0.039145257, 0.0636315, 0.029647764, 0.039150815, -0.010462398, -0.07060258, 0.06866964, -0.025669314, -3.3814054e-08, -0.0076291705, 0.004906816, 0.03726866, 0.02580839, 0.11193258, 0.1181559, 0.0012781284, -0.12075609, 0.08089903, 0.058266997, 0.017137613, 0.007800943, 0.039573185, 0.0014222931, -0.011845155, -0.0028635778, -0.08671207, -4.1076033e-05, -0.021071177, -0.030771177, 0.032305457, 0.028102202, 0.11228853, -0.09829012, -0.07167897, -0.009987383, -0.041310947, -0.047306165, -0.064440444, -0.06768261, 0.060030606, 0.12163415, 0.047166657, -0.058253404, 0.025144769, -0.03556815, 0.029521752, 0.01727546, -0.01726652, -0.047185097, 0.0015566144, 0.029345926, 0.09577577, -0.041469898, -0.0693009, -0.07868783, -0.020413572, -0.0010663307, -0.06467947, 0.0077057737, -0.04020514, -0.016908249, 0.0781586, 0.023701996, 0.093215786, -0.026730398, -0.08033901, 0.009581974, -0.0134685915, 0.014020938, 0.10276293, -0.11387213, -0.020509513, -0.070237376];
    const userAudioVector = [-0.032596778,-0.016924502,0.034467347,0.059601106,0.040930316,-0.039287105,0.027507192,-0.025328206,0.020487824,-0.029613413,0.04842203,-0.03484134,-0.026151143,0.037913937,-0.01696597,-0.010486516,0.051020868,-0.05872375,0.041999266,0.013874208,0.09906411,0.03309355,-0.041574173,0.0018892294,-0.08454637,0.037336268,-0.025538793,0.06490155,-0.0128419055,-0.045975726,-0.03962346,-0.007725183,0.07365927,-0.012586834,0.009488661,0.002354888,-0.038687434,-0.018502256,-0.0979025,-0.027926518,-0.05124163,-0.032702222,0.0022330098,-0.00025658804,-0.061556987,0.035531335,0.1086845,0.014074202,0.009570268,-0.031091653,-0.022397317,-0.007854741,-0.036468484,0.007998636,0.04491018,-0.011166356,-0.003953559,-0.04700968,-0.05315187,0.07838282,-0.10950633,-0.022210356,0.05860715,-0.017253593,-0.0139948,0.07849201,-0.10513546,0.014289589,0.0049409396,-0.007948086,0.083389655,-0.001668188,0.06847018,-0.06612938,-0.029334547,-0.0379193,0.014414743,0.024587393,-0.06073705,0.057488132,-0.00921052,-0.06017008,0.035903066,-0.041056704,-0.028611684,0.06558354,-0.046946086,0.070846096,0.04350344,-0.044755828,0.02006019,-0.023777358,-0.009834622,0.03828285,-0.078614786,-0.018995075,-0.0441794,0.017161459,0.035359718,-0.01266751,-0.08088061,0.0070786267,0.0030759727,-9.1749745e-05,0.045833312,-0.030167185,0.09085211,-0.028967572,0.024692621,-0.009366489,0.012692349,0.06123688,0.06684308,-0.115250506,-0.008425838,0.07671774,0.065001436,0.08067503,0.008108536,0.05259994,-0.0040782383,0.07585091,-0.12388496,-0.01310016,-0.043834593,0.007876212,0.0029494378,0.03482003,-0.01384013,0.08247232,-0.042228714,-0.08414603,-0.102059826,0.037448492,-0.014850014,-0.0143569745,0.020228203,-0.0193301,0.104986265,0.017829256,-0.04345747,-0.05137812,0.0856282,-0.008028384,0.052848913,-0.017852016,0.025011688,-0.006584037,-0.062377427,0.015412535,0.020283112,-0.017314808,0.010970657,0.0015773717,0.043464,0.045422245,-0.053000964,-0.008043747,-0.05730576,0.01972059,-0.010585939,-0.020274198,-0.030793324,0.05086822,0.06152529,-0.014543237,-0.032573324,0.0149081675,-0.034634106,0.038211424,0.031948045,0.00745518,0.019956315,0.056590293,-0.01129387,0.006163174,-0.070131086,-0.0135842655,-0.044123776,0.10466378,-0.041443046,0.065187566,0.05275399,0.0057233637,-0.062939554,-0.016456844,0.0782807,-0.0001410932,0.06776121,-0.03360867,-0.07520807,-0.006182418,-0.0020394714,-0.03746435,0.045466587,0.04958235,0.010828518,0.033043507,0.031854726,-0.016439585,-0.05860668,-0.053183928,0.0123109305,0.00634406,0.01792185,-0.008184009,-0.009021288,0.09405408,0.07591413,-0.047775995,-0.019603059,0.038786944,-0.015195159,-0.068853445,0.043991193,0.049159218,-0.0060085333,0.08894088,0.07618624,0.018891256,-0.005308881,-0.0011249835,-0.093550205,-0.021763857,0.015022434,-0.06129086,0.057710994,0.045889117,-0.027257396,-0.0070575955,0.00021710253,0.0006846334,-0.06610432,-0.049499754,0.012310962,0.04558641,0.018051319,0.0013446031,-0.025828192,0.064167224,0.0093251625,-0.031627253,-0.021391973,-0.05207837,-0.017617242,-0.03166244,0.047184344,0.0576801,0.06892094,-0.039710023,0.0047115693,0.01795904,0.0026105435,-0.03640408,-0.08375138,-0.09107091,-0.025550326,-0.092151925,-0.01540689,-0.042190295,0.048113696,-0.057337057,0.031826355,0.0031444803,0.086876735,-0.05690204,-0.029334653,-0.057452396,-0.069940485,0.014322637,0.0054873587,0.02268744,-0.00010422741,0.040223103,-0.000223431,-0.012887489,-0.010019685,-0.0602127,0.067146346,0.009020348,-0.07835729,-0.060154866,0.017161014,0.02981921,0.00278993,0.053395886,-0.054293007,-0.025073238,-0.0142472815,-0.029109819,0.047430642,-0.09435861,0.032806322,0.002950926,0.019420395,-0.009152876,-0.050721034,0.032105546,0.017910348,-0.06556436,0.042021632,0.0265525,-0.05419793,0.0068251044,-0.07460917,0.014982809,-0.05115417,-0.004303587,0.06931806,-0.053578205,-0.06308978,0.0750261,-0.005443193,0.006616867,-0.028440244,-0.005418744,-0.002850462,0.010657865,-0.01621364,-0.0032335853,-0.04070599,-0.02494827,0.05535282,0.0016961502,-0.03478385,0.063758925,0.01752156,0.07027212,0.053196218,0.038008314,0.04678057,0.019253906,-0.037345205,-0.021890538,0.011695462,0.0255765,0.0107436795,0.04166609,0.017660303,0.011454081,0.01928462,0.04308926,-0.018886643,-0.040927965,0.048381697,-0.023688106,-0.084595636,-0.046752524,0.0457767,0.043105513,-0.057197724,0.022133213,0.04599909,0.012180255,0.0010486579,-0.010696608,-0.13003448,0.022558486,0.01702544,-0.04024894,-0.024184287,0.011141303,0.031957068,-0.01376898,-0.028569663,-0.06904437,-0.017403688,0.037536122,-0.017248143,-0.0010707917,-0.10180228,0.031319514,0.004352673,0.027977325,0.026203517,0.030699288,0.037090704,-0.03116481,0.059167363,0.012015808,0.0374054,0.03311916,0.07387212,-0.016916683,0.05399579,-0.048254855,0.05403247,0.011757531,0.0040648207,-0.027411435,-0.017170422,-0.01565394,-0.06860734,0.06219077,0.0618622,0.0064439443,-0.035553247,0.0771017,-0.019884963,0.054885138,-0.005879368,-0.05863566,-0.021411007,-0.058147613,-0.07105231,-0.027056225,-0.052882437,-0.037958376,0.045708105,0.018761128,0.07417443,0.033457845,0.028304411,-0.007889838,-0.027995132,-0.068500414,0.063725665,0.03586724,0.01788587,0.035009805,0.09419815,-0.007934471,0.007193824,0.05544542,-0.024763906,0.015854489,-0.04982753,0.0026585758,0.059507683,-0.05312652,-0.007959287,0.0016430437,0.018953012,-0.07348668,-0.014637971,0.03969563,-0.063836925,0.030651476,0.02762632,0.03480915,-0.016409827,0.034401547,0.0038392819,0.039079193,-0.024296304,-0.0027312476,-0.048753716,0.004401626,-0.015890054,0.007980103,-0.02380995,0.004157276,0.01375329,0.030515723,-0.008049019,0.01650081,-0.014505353,0.007208895,0.017987356,0.046317812,-0.0047566737,0.019388376,0.01979592,0.004198221,0.028401863,0.00027629908,-0.012534568,0.026651347,0.060816623,0.006323474,-0.08090475,0.00010609858,-0.05157109,-0.06596607,0.025195757,0.06605347,0.005410964,0.0043286714,-0.01329317,-0.014848975,-0.061766822,-0.018022124,0.00079045957,0.013180408,0.15130247,-0.0053321775,0.022939695,0.064124465,0.05866118,0.06600072,0.052266218,-0.04310283,0.01770663,0.044369075,-0.020830678,0.038080774,-0.018600209,0.016463682,0.060828865,0.0024670481,0.038524073,-0.001661004,0.09017762,-0.036405593,0.011213139,-0.014333367,0.025610035,-0.006620882,0.054362427,0.010696885,0.025399232,-0.030685011]

    const results = await getSimilarSoundingTracks(userAudioVector, 10, 0);
    return res.status(200).json({
        success: true,
        data: { tracks: results }
    })


    // const userId = "pnoh3p2yCJMa9AjH18bnCiDhCmtGeM8s";

    // const job = await personalizationQueue.add('personalization', { type: 'for_you', user_id: userId });

    // try {
    //     const result = await job.waitUntilFinished(personalizationQueueEvents);
    //     console.log("Job completed with result:", result);
    //     res.json({ jobId: job.id, result });
    // } catch (err: any) {
    //     console.error("Job failed with error:", err);
    //     res.status(500).json({ jobId: job.id, error: err?.message ?? String(err) });
    // }
});


app.use(errorHandler);


app.listen(config.port, () => {
    console.log(`Backend listening on port ${config.port}`);
    // checkMeiliConnection();
});
